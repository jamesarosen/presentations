<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=1024, user-scalable=no">

    <title>Carson - Adventures with Engines</title>

    <link rel="stylesheet" href="../deck/core/deck.core.css">
    <link rel="stylesheet" href="../deck/extensions/status/deck.status.css">
    <link rel="stylesheet" href="../deck/extensions/hash/deck.hash.css">
    <link rel="stylesheet" href="../deck/extensions/scale/deck.scale.css">
    <link rel="stylesheet" href="../deck/themes/transition/vertical-slide.css">
    <link rel="stylesheet" href="../deck/themes/style/zendesk.css">
    <link rel="stylesheet" href="assets/carson.css">

    <script src="../deck/assets/modernizr.custom.js"></script>
  </head>
  <body class="deck-container">
    <!-- slides -->
    <section class="slide chapter green">
      <h1>
        <img src="../deck/themes/style/buddhy.png" />
      </h1>
    </section>

    <section class="slide chapter green">
      <h1>Chapter 0: <code>whoami</code></h1>
    </section>

    <section class='slide'>
      <p>James A. Rosen</p>
      <p>Senior User Happiness Engineer, Zendesk</p>
      <p>@jamearosen</p>
      <p>https://github.com/jamesarosen</p>
    </section>

    <section class="slide chapter green">
      <h1>
        Carson
        <cite>https://github.com/jamesarosen/presentations/carson</cite>
      </h1>
    </section>

    <section class="slide chapter green">
      <h1>Chapter 1: Introduction</h1>
    </section>

    <section class="slide">
      <header>The Rails App</header>
      <div id='rails-versions'>
        <img src='assets/rails logo.png' />
        <span class='slide incremental'>v1.2</span>
        <span class='slide incremental'>v2.0</span>
        <span class='slide incremental'>v2.1</span>
        <span class='slide incremental'>v2.2</span>
        <span class='slide incremental'>v2.3</span>
        <span class='slide incremental danger'>v2.3.8</span>
        <span class='slide incremental'>v2.3.14</span>
      </div>
    </section>

    <section class="slide">
      <header>Non-Rails Services</header>
      <div id='other-services'>
        <img src='assets/rails logo.png' class='slide incremental' />
        <img src='assets/sphinx logo.jpg' class='slide incremental' />
        <img src='assets/solr logo.png' class='slide incremental' />
        <img src='assets/ejabberd logo.png' class='slide incremental' />
        <img src='assets/nodejs logo.png' class='slide incremental' />
        <img src='assets/resque logo.png' class='slide incremental' />
      </div>
    </section>

    <section class="slide">
      <img src='assets/code_vs_test.png' class='full' id='code-to-test' />
    </section>

    <section class="slide">
      <header>Developer Happiness</header>
      <figure>
        <img src='assets/metz-satisfaction-head.png' class='full developer-happiness-graph' />
        <figcaption>https://speakerdeck.com/u/skmetz/p/go-ahead-make-a-mess</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Developer Happiness</header>
      <figure>
        <img src='assets/metz-satisfaction-tail.png' class='full developer-happiness-graph' />
        <figcaption>https://speakerdeck.com/u/skmetz/p/go-ahead-make-a-mess</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Solution 1: Fast Test Suite</header>
      <figure>
        <img src='assets/corey-with-cat.jpg' class='full' id='corey-with-cat' />
        <figcaption>http://twitpic.com/ashs8m/full</figcaption>
      </figure>
    </section>

    <section class='slide'>
      <blockquote>
        Organizations which design systems&hellip; are constrained to produce designs
        which are copies of the communication structures of these organizations.
        <cite>Conway's Law</cite>
      </blockquote>
    </section>

    <section class="slide chapter green">
      <span class='badge orange'>IMPORTANT!</span>
      <h1>Takeaway:<br />Break up the Team</h1>
    </section>

    <section class="slide">
      <header>Sea Monster the CMS</header>
      <figure>
        <img src='assets/sea_monster.jpg' class='full' id='sea-monster' />
        <figcaption>http://www.flickr.com/photos/btsiders/74652478/</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Rails 2 &amp; Assets</header>
      <figure>
        <img src='assets/sprocket.jpg' class='full' id='sprocket' />
        <figcaption>http://www.flickr.com/photos/amberandclint/4215036529/</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Zaphod</header>
      <figure>
        <img src='assets/zaphod_lego.jpg' class='full' id='zaphod' />
        <figcaption>http://www.flickr.com/photos/bladewood/2839103821/</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Zaphod's Stress Level</header>
      <figure>
        <img src='assets/stressed_eggs.png' class='full' id='stressed-eggs' />
        <figcaption>http://www.flickr.com/photos/topgold/6273248505/</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Meetings were Held</header>
      <figure>
        <img src='assets/cat_meeting.jpg' class='full' id='cat-meeting' />
        <figcaption>http://cheezburger.com/5833564416</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Coffee was Consumed</header>
      <figure>
        <img src='assets/bulleit.jpg' class='full' id='bulleit' />
        <figcaption>http://www.flickr.com/photos/9525555@N07/6071862938/</figcaption>
      </figure>
    </section>

    <section class="slide">
      <header>Carson was Born</header>
      <figure>
        <img src='assets/carnac.jpg' class='full' id='carnac-the-magnificent' />
        <figcaption>Carnac the Magnificent</figcaption>
      </figure>
    </section>

    <section class="slide chapter green">
      <span class='badge orange'>IMPORTANT!</span>
      <h1>Takeaway:<br />Communicate with and trust ops</h1>
    </section>

    <section class="slide chapter green">
      <h1>Chapter 2: Carson</h1>
    </section>

    <section class="slide">
      <blockquote>
        If it weren't for Philo T. Farnsworth, inventor of television, we'd
        still be eating frozen radio dinners.
        <cite>Johnny Carson</cite>
      </blockquote>
    </section>

    <section class="slide">
      <header>Baby Steps</header>
      <figure>
        <img src='assets/baby-steps.jpg' class='full' id='baby-steps' />
        <figcaption><i>What About Bob</i>, Touchstone Pictures, 1991</figcaption>
      </figure>
    </section>

    <section class="slide">
      <pre>
            - carson
              - config
                - database.yml
                - environment.rb
                + environments
                + initializers
              - Gemfile
              - Gemfile.lock
              - spec
                + integration</pre>
    </section>

    <section class='slide'>
      <header>Organizing Principles</header>
      <ul>
        <li class='slide incremental'>
          Engines for features
        </li>
        <li class='slide incremental'>
          Gems for cross-cutting concerns
        </li>
        <li class='slide incremental'>
          Only initializers in Carson proper
        </li>
      </ul>
    </section>

    <section class="slide chapter green">
      <h1>Chapter 3: Benefits &amp; Drawbacks</h1>
    </section>

    <section class='slide'>
      <header>Testing</header>
      <ul>
        <li class='slide incremental'>
          + Smaller test suites -> run in &lt; 1 minute
        </li>
        <li class='slide incremental'>
          + One CI build per engine -> better notifications
        </li>
        <li class='slide incremental'>
          - Need integration tests in Carson
        </li>
      </ul>
    </section>

    <section class='slide'>
      <header>Semantic Versioning</header>
      <ul>
        <li class='slide incremental'>
          + Decoupled deploy schedules
        </li>
        <li class='slide incremental'>
          + Patch updates with <code>bundle update my_engine</code>
        </li>
        <li class='slide incremental'>
          - Painful without internal gem server
        </li>
      </ul>
    </section>

    <section class='slide'>
      <header>Continuous Deployment</header>
      <pre>
      bundle update &amp;&amp; \
        rake test &amp;&amp; \
        git commit -m "updating gems" &amp;&amp; \
        git push &amp;&amp; \
        cap deploy</pre>
    </section>

    <section class="slide">
      <header>Dependency Management</header>
      <figure>
        <img src='assets/sad_pumpkin.jpg' class='full' />
        <figcaption>http://www.flickr.com/photos/nathaninsandiego/4061850729/</figcaption>
      </figure>
    </section>

    <section class='slide'>
      <header>Upgrading a Dependency</header>
      <ul>
        <li class='slide incremental'>
          Big-ball-of-mud: <code>bundle exec hope-nothing-breaks</code>
        </li>
        <li class='slide incremental'>
          <code>gemspec</code>s add information about who depends on what
        </li>
        <li class='slide incremental'>
          + Harder to break other code
        </li>
        <li class='slide incremental'>
          - More meetings
        </li>
        <li class='slide incremental'>
          <code>Gemfile</code>/<code>.gemspec</code> duplication w/o internal
          gem server
        </li>
      </ul>
    </section>

    <section class='slide'>
      <header>Deployment</header>
      <ul>
        <li class='slide incremental'>
          Deploy Carson with Capistrano
        </li>
        <li class='slide incremental'>
          Single <code>deploy.rb</code>, n features
        </li>
        <li class='slide incremental'>
          Just like big-ball-of-mud, cannot scale independently
        </li>
      </ul>
    </section>

    <section class='slide'>
      <header>Single, Central Database</header>
      <ul>
        <li class='slide incremental'>
          No worse than big-ball-of-mud
        </li>
        <li class='slide incremental'>
          Not as decoupled as real SOA
        </li>
        <li class='slide incremental'>
          See
          <a href='http://thunderboltlabs.com/posts/soa-antipattern-centralized-db'>
            Thunderbolt Labs's Essay
          </a>
        </li>
      </ul>
    </section>

    <section class='slide chapter green'>
      <h1>Chapter 4: Patterns and Anti-Patterns</h1>
    </section>

    <section class='slide'>
      <blockquote>
        I did not know that.
        <cite>Johnny Carson</cite>
      </blockquote>
    </section>

    <section class='slide chapter green'>
      <h3>Pattern: Namespacing</h3>
    </section>

    <section class='slide'>
      <header>Namespacing</header>
      <ul>
        <li class='slide incremental'>
          Ruby: <code>Zendesk::Provisioning</code>
        </li>
        <li class='slide incremental'>
          Database: <code>provisioning_*</code>
        </li>
        <li class='slide incremental'>
          I18n keys: <code>provisioning.*</code>
        </li>
        <li class='slide incremental'>
          HTML pages: <code>/provisioning/*</code>
        </li>
        <li class='slide incremental'>
          Assets: <code>/assets/provisioning/*</code>
        </li>
        <li class='slide incremental'>
          API endpoints: <code>/api/v*/provisioning/*</code>
        </li>
      </ul>
    </section>

    <section class='slide chapter green'>
      <h3>Anti-Pattern: Unexpected Global State</h3>
    </section>

    <section class='slide'>
      <header>Global State</header>
      <ul>
        <li class='slide incremental'>
          <code>I18n.locale</code> and <code>I18n.default_locale</code>
        </li>
        <li class='slide incremental'>
          <code>I18n.backend</code>
        </li>
        <li class='slide incremental'>
          Translation data
        </li>
        <li class='slide incremental'>
          Database Schema
        </li>
        <li class='slide incremental'>
          Rack middleware
        </li>
        <li class='slide incremental'>
          MIME type mappings
        </li>
      </ul>
    </section>

    <section class='slide'>
      <header>Global State Case Study</header>
      <pre>
class Provisioning::Engine &lt; Rails::Engine
  initializer :i18n_backend do
    I18n.backend = I18n::Backend::Simple.new(...)
  end
end</pre>
    </section>

    <section class='slide'>
      <header>Global State Case Study</header>
      <ol>
        <li class='slide incremental'>
          Agree on a convention
        </li>
        <li class='slide incremental'>
          Encode convention as gem
        </li>
        <li class='slide incremental'>
          Include gem in each (relevant) engine
        </li>
      </ol>
    </section>

    <section class='slide'>
      <header>Global State Case Study</header>
      <pre>
class Provisioning::Engine &lt; Rails::Engine
  initializer :i18n do
    Zendesk::I18n.init(self)  # idempotent
  end
end</pre>
    </section>

    <section class="slide chapter green">
      <span class='badge orange'>IMPORTANT!</span>
      <h1>Takeaway:<br />Beware global state</h1>
    </section>

    <section class="slide chapter green">
      <span class='badge orange'>FREE BONUS!</span>
      <h1>Bonus Takeaway:<br />Encode conventions as gems</h1>
    </section>

    <section class='slide chapter green'>
      <h3>Pattern: <code>AS::Notifications</code></h3>
    </section>

    <section class='slide'>
      <header>Good</header>
      <pre>
class Provisioning::Account &lt; ActiveRecord::Base
  after_save :send_notifications

  private

  def send_notifications
    ActiveSupport::Notifications.instrument(
      "account.changed"
    )
  end
end</pre>
    </section>

    <section class='slide'>
      <header>Better</header>
      <pre>
class Provisioning::Account &lt; ActiveRecord::Base
  after_save :send_notifications

  private

  def send_notifications
    if ssl_certificate.changed?
      ActiveSupport::Notifications.instrument(
        "account.ssl_certificate.changed",
        ssl_certificate
      )
    end
  end
end</pre>
    </section>

    <section class='slide chapter'>
      <h1>Antipattern: Shared, Mutable Objects</h1>
    </section>

    <section class="slide">
      <header>Williams, Master of <code>COMEFROM</code></header>
      <figure>
        <img src='assets/reg_braithwaite.jpg' class='full' />
        <figcaption>http://hyfen.net/stackoverflow-devdays</figcaption>
      </figure>
    </section>

    <section class='slide'>
      <header>Classic Rails App</header>
      <pre>
      class Person
        has_many :comments
      end

      class Comment
        belongs_to :person
      end</pre>
    </section>

    <section class='slide'>
      <header>Williams Rails App</header>
      <pre>
  class People::Person
  end</pre>
      <pre>
  class Commenting::Comment
    belongs_to :author,
               :class_name => 'People::Person'
  end

  People::Person.class_eval do
    has_many :comments,
             :class_name => 'Commenting::Comment'
  end</pre>
    </section>

    <section class='slide'>
      <header>Danger!</header>
      <pre class='slide incremental'>
  People::Person.class_eval do
    validates_presence_of :email
  end</pre>
      <pre class='slide incremental'>
  People::Person.class_eval do
    before_save :something_that_could_fail
  end</pre>
    </section>

    <section class='slide'>
      <h2>
        If it's not your data and it's not your code, you can't change it.
      </h2>
    </section>

    <section class='slide'>
      <header>OK: Copies of Model Classes</header>
      <pre>
class Commenting::Author
  self.table_name = 'people'

  has_many :comments,
           :class_name => 'Commenting::Comment'

  def readonly?
    true
  end
end

class Commenting::Comment
  belongs_to :author,
             :class_name => 'Commenting::Author'
end</pre>
    </section>

    <section class='slide'>
      <header>Dependencies</header>
      <ul>
        <li class='slide incremental'>same database</li>
        <li class='slide incremental'>table <code>people</code></li>
        <li class='slide incremental'>PK column <code>people.id</code></li>
        <li class='slide incremental'>more? -> unstable</code></li>
        <li class='slide incremental'>Engine -> Engine: <code>:`(</code></li>
      </ul>
    </section>

    <section class='slide'>
      <header>Better: Ruby APIs</header>
      <pre>
class People::Person &lt; ActiveRecord::Base
  def self.lookup(id)
    find(id).tap do |person|
      def person.readonly?
        true
      end
    end
  end
end</pre>
    </section>

    <section class='slide'>
      <header>Dependencies</header>
      <ul>
        <li class='slide incremental'>engines in same container</li>
        <li class='slide incremental'>class <code>People::Person</code></li>
        <li class='slide incremental'>method <code>.lookup</code></li>
        <li class='slide incremental'>argument <code>id</code></li>
        <li class='slide incremental'>Engine -> Engine: <code>:`(</code></li>
      </ul>
    </section>

    <section class='slide'>
      <h2>Ruby has no package privacy = <code>:`(</code></h2>
      <pre>
class Commenting::CommentController
  @people = People::Person.all
end</pre>
    </section>

    <section class='slide'>
      <header>Extract Engine to Service</header>
      <pre>
class People::Person # not &lt; ActiveRecord::Base
  def self.lookup(id)
    json = get("http://people.services/people/#{id}")
    new( MultiJson.decode( json ) )
  end
end</pre>
    </section>

    <section class='slide'>
      <header>Best: Client Gem</header>
      <ul>
        <li class='slide incremental'>
          Each feature that has clients builds a consumer gem
        </li>
        <li class='slide incremental'>
          No Engine -> Engine dependencies = <code>:)</code>
        </li>
        <li class='slide incremental'>
          + Semantic versioning
        </li>
        <li class='slide incremental'>
          Build the client first!
        </li>
      </ul>
    </section>

    <section class="slide chapter green">
      <span class='badge orange'>IMPORTANT!</span>
      <h1>Takeaway:<br />Only modify own code/data</h1>
    </section>

    <section class='slide chapter green'>
      <h1>Chapter 5: The Future</h1>
    </section>

    <section class='slide'>
      <blockquote>
        Only lie about the future.
        <cite>Johnny Carson</cite>
      </blockquote>
    </section>

    <section class='slide chapter'>
      <header>Summary</header>
      <p>No worse than big-ball-of-mud*</p>
      <p>Why? Stepping stone to SOA</p>
    </section>

    <section class="slide chapter green">
      <span class='badge orange'>We're Hiring!</span>
      <h1>
        <img src="../deck/themes/style/buddhy.png" />
      </h1>
    </section>

    <section class='slide chapter'>
      <header>Further Reading</header>
      <ul>
        <li>https://github.com/jamesarosen/presentations/tree/master/carson</li>
        <li>http://www.slideshare.net/jackdanger/monorails-gogaruco-2012</li>
        <li>http://confreaks.com/videos/1125-gogaruco2012-mega-rails</li>
        <li>http://en.wikipedia.org/wiki/Conway's_Law</li>
        <li>http://thunderboltlabs.com/posts/soa-antipattern-centralized-db</li>
      </ul>
    </section>

    <section class='slide chapter'>
      <header><em>Further</em> Further Reading</header>
        <li>http://github.com/raganwald/homoiconic/blob/master/2011/11/COMEFROM.md</li>
        <li>http://confreaks.com/videos/1115-gogaruco2012-go-ahead-make-a-mess</li>
        <li>https://speakerdeck.com/u/skmetz/p/go-ahead-make-a-mess</li>
        <li>https://www.youtube.com/watch?v=bNn6M2vqxHE</li>
      </ul>
    </section>

    <!-- deck.status snippet -->
    <p class="deck-status">
      <span class="deck-status-current"></span>
      /
      <span class="deck-status-total"></span>
    </p>

    <!-- Required JS files. -->
    <script src="../deck/assets/jquery-1.7.2.min.js"></script>
    <script src="../deck/core/deck.core.js"></script>

    <!-- Extension JS files. Add or remove as needed. -->
    <script src="../deck/extensions/hash/deck.hash.js"></script>
    <script src="../deck/extensions/status/deck.status.js"></script>
    <script src="../deck/extensions/scale/deck.scale.js"></script>

    <!-- Initialize the deck. You can put this in an external file if desired. -->
    <script>
      $(function() {
        $(document).bind('deck.beforeInit', function() {
          $('.deck-container > .slide')
            .not('.chapter.green')
            .not('.buddhy')
              .each(function() {
                if ( $(this).find('header').length === 0 ) {
                  $(this).prepend('<header />');
                }
              });
        });

        $.deck('.slide');
      });
    </script>
  </body>
</html>
